#!/usr/bin/env bash

# Author: Mohammed Albatati
# Date: 20251110
# Get the Asset details using fzf, I've created a file exporeted from sqlite database and I use this to
# fzf based on the file.
# Update: 20260130 I added the color options
#

set -e
# Ensure the asset csv file is available and if not then create it
[ ! -f "$HOME/org/Exported_database_2026_noes.csv" ] && echo 'File not available at temp directory  Creating a new csv file'

fzfAssets() {
    local color_enabled=false
    while getopts "c" opt; do
        case "$opt" in
            c) color_enabled=true ;;
            *) echo "Usage: $0 [-c]" >&2; exit 1 ;;
        esac
    done
    shift $((OPTIND-1))

    local awk_format=""
    local fzf_opts="-m" # Default

    if "$color_enabled"; then
        awk_format='%-8s \033[35m%-12s\033[0m %-20s \033[33m%-20s\033[0m %-5s \033[34m%-10s\033[0m %-5s %-5s %-5s %-5s \033[36m%-5s\033[0m %-5s %-5s\n'

        # Check fzf version for --no-strip-ansi support, which was added in v0.28.0
        fzf_version=$(fzf --version 2>/dev/null | awk '{print $1}')
        required_version="0.28.0"

        if [ -n "$fzf_version" ] && [ "$(printf '%s\n' "$required_version" "$fzf_version" | sort -V | head -n1)" = "$required_version" ]; then
            # fzf_version is >= required_version
            fzf_opts="-m --ansi"
        else
            # fzf_version is too old or could not be determined
            fzf_opts="-m --ansi"
            if [ -n "$fzf_version" ]; then
                echo "Warning: Your fzf version ($fzf_version) is older than $required_version. The final output will not be colored." >&2
                echo "         Please upgrade fzf to 0.28.0 or newer for this feature." >&2
            else
                echo "Warning: Could not determine fzf version. The final output will not be colored." >&2
            fi
        fi
    else
        awk_format='%-8s %-12s %-20s %-20s %-5s %-10s %-5s %-5s %-5s %-5s %-5s %-5s %-5s\n'
    fi
    grepID=$(awk -F"," "{printf \"$awk_format\", \$1, \$2, \$3, \$4, \$5, \$6, \$7, \$8, \$9, \$10, \$11, \$12, \$13}" "/Users/mohammedalbatati/org/Exported_database_20251110.csv" | fzf $fzf_opts)
    echo "$grepID"
}
fzfAssets "$@"



